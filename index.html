<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<title>SimpleShare</title>
<script src="https://unpkg.com/petite-vue@0.4.1/dist/petite-vue.iife.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:monospace;background:#f5f5f5;padding:10px;font-size:14px;line-height:1.5}
[v-cloak]{display:none}
[BTN]{cursor:pointer!important;border:1px solid #999!important;padding:8px 14px!important;background:#fff!important;border-radius:2px!important;display:inline-block!important;font-size:14px!important;transition:background 0.2s,border-color 0.2s!important;text-decoration:none!important;color:#333!important}
[BTN]:hover{background:#e0e0e0!important;border-color:#777!important}
[BTN]:active{background:#d0d0d0!important}
[FLEXR]{display:flex;gap:10px;flex-wrap:wrap}
[FLEXC]{display:flex;flex-direction:column;gap:10px}
.card{border:1px solid #ccc;padding:15px;background:#fff;border-radius:2px;box-shadow:0 1px 2px rgba(0,0,0,0.05)}
.tab{border:1px solid #999;padding:8px 16px;background:#fff;cursor:pointer;border-radius:2px 2px 0 0;border-bottom:none;font-size:14px;white-space:nowrap}
.tab.actv{background:#e0e0e0;font-weight:bold}
.tabs-container{border-bottom:1px solid #999;margin-bottom:15px;display:flex;gap:2px;flex-wrap:wrap}
.progress-bar{height:3px;background:#e0e0e0;position:relative;margin-top:5px;border-radius:2px;overflow:hidden}
.progress-fill{height:100%;background:#4caf50;width:0%;transition:none}
.textarea-wrapper{position:relative}
textarea{width:100%;font-family:monospace;border:1px solid #999;padding:10px;resize:vertical;border-radius:2px;font-size:14px}
input[type="text"]{width:100%;border:1px solid #999;padding:8px;font-family:monospace;border-radius:2px;font-size:14px}
input[type="file"]{border:1px solid #999;padding:6px;border-radius:2px;font-size:14px}
input[type="checkbox"]{cursor:pointer;margin-right:6px}
label{cursor:pointer;font-size:14px;display:flex;align-items:center}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
.upload-section{margin-bottom:15px}
.text-controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
</style>
</head>
<body v-scope @vue:mounted="authLoop" v-cloak>

<div v-if="authed">
    <div class="tabs-container">
        <div class="tab" :class="{actv: mainTab==='texts'}" @click="mainTab='texts'; if (texts.length && !currentText) openText(texts[0].name)">üìù Txts</div>
        <div class="tab" :class="{actv: mainTab==='uploads'}" @click="mainTab='uploads'">üìÅ Uploads</div>
    </div>

    <div v-if="mainTab==='uploads'" [FLEXC]>
        <div class="card upload-section">
            <label [BTN] style="display:inline-block">
                üì§ Choose File
                <input type="file" @change="uploadFile" style="display:none">
            </label>
        </div>
        <div class="grid">
            <div v-for="f in files" class="card" [FLEXC]>
                <strong>{{f.name}}</strong>
                <span>{{formatSize(f.size)}}</span>
                <div [FLEXR]>
                    <a :href="'/files/'+f.name" download [BTN]>‚¨áÔ∏è Download</a>
                    <span [BTN] @click="deleteFile(f.name)">üóëÔ∏è Delete</span>
                </div>
            </div>
        </div>
    </div>

    <div v-if="mainTab==='texts'" [FLEXC]>
        <div class="tabs-container">
            <div v-for="t in texts" class="tab" :class="{actv: currentText?.name===t.name}" @click="openText(t.name)">
                {{t.name}}
            </div>
            <div class="tab" @click="newText">+</div>
        </div>

        <div v-if="currentText" class="card" [FLEXC]>
            <input type="text" v-model="currentText.name" @input="onTextChange" placeholder="Text name">
            <div class="textarea-wrapper">
                <textarea v-model="currentText.content" @input="onTextChange" rows="15"></textarea>
                <div class="progress-bar">
                    <div class="progress-fill" :style="{width: progressWidth + '%'}"></div>
                </div>
            </div>
            <div class="text-controls">
                <label [BTN]>
                    <input type="checkbox" v-model="currentText.open" @change="onTextChange">
                    <span>üåê Public</span>
                </label>
                <span [BTN] @click="deleteText(currentText.name)">üóëÔ∏è Delete</span>
            </div>
        </div>
        <div v-else-if="texts.length === 0" class="card">
            <p>No texts yet. Click + to create one.</p>
        </div>
    </div>
</div>

<script>
PetiteVue.createApp({
    authed: false,
    mainTab: 'texts',
    files: [],
    texts: [],
    currentText: null,
    debounceTimer: null,
    progressInterval: null,
    progressWidth: 0,

    async authLoop() {
        try {
            const res = await fetch('/auth');
            if (res.ok) {
                this.authed = true;
                this.init();
                return;
            }
        } catch (e) {
            console.error(e);
        }
        
        while (!this.authed) {
            const pass = prompt('Password:');
            if (!pass) continue;
            try {
                const res = await fetch('/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({password: pass})
                });
                if (res.ok) {
                    this.authed = true;
                    this.init();
                    break;
                }
            } catch (e) {
                console.error(e);
            }
        }
    },

    async init() {
        await this.loadFiles();
        await this.loadTexts();
    },

    async loadFiles() {
        try {
            const res = await fetch('/files');
            this.files = res.ok ? await res.json() : [];
        } catch (e) {
            console.error(e);
        }
    },

    async loadTexts() {
        try {
            const res = await fetch('/txts');
            this.texts = res.ok ? await res.json() : [];
            if (this.texts.length > 0 && !this.currentText) {
                await this.openText(this.texts[0].name);
            }
        } catch (e) {
            console.error(e);
        }
    },

    async uploadFile(e) {
        const file = e.target.files[0];
        if (!file) return;
        const formData = new FormData();
        formData.append('file', file);
        try {
            await fetch('/upload', {method: 'POST', body: formData});
            await this.loadFiles();
            e.target.value = '';
        } catch (e) {
            console.error(e);
        }
    },

    async deleteFile(name) {
        if (!confirm(`Delete ${name}?`)) return;
        try {
            await fetch(`/files/${name}`, {method: 'DELETE'});
            await this.loadFiles();
        } catch (e) {
            console.error(e);
        }
    },

    async openText(name) {
        try {
            const res = await fetch(`/txt/${name}`);
            if (res.ok) {
                const data = await res.json();
                this.currentText = {...data, name};
            }
        } catch (e) {
            console.error(e);
        }
    },

    onTextChange() {
        clearTimeout(this.debounceTimer);
        clearInterval(this.progressInterval);
        this.progressWidth = 0;
        
        const startTime = Date.now();
        const duration = 1500;
        
        this.progressInterval = setInterval(() => {
            const elapsed = Date.now() - startTime;
            this.progressWidth = Math.min((elapsed / duration) * 100, 100);
        }, 50);
        
        this.debounceTimer = setTimeout(() => {
            clearInterval(this.progressInterval);
            this.progressWidth = 100;
            this.saveText();
        }, duration);
    },

    async saveText() {
        if (!this.currentText?.name) return;
        try {
            await fetch(`/txt/${this.currentText.name}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    content: this.currentText.content,
                    open: this.currentText.open
                })
            });
            await this.loadTexts();
            setTimeout(() => { this.progressWidth = 0; }, 500);
        } catch (e) {
            console.error(e);
            this.progressWidth = 0;
        }
    },

    async newText() {
        let name = 'new';
        let counter = 1;
        const existingNames = this.texts.map(t => t.name);
        
        while (existingNames.includes(name)) {
            counter++;
            name = `new${counter}`;
        }
        
        this.currentText = {name, content: '', open: false};
        await this.saveText();
    },

    async deleteText(name) {
        if (!confirm(`Delete ${name}?`)) return;
        try {
            await fetch(`/txt/${name}`, {method: 'DELETE'});
            if (this.currentText?.name === name) {
                this.currentText = null;
            }
            await this.loadTexts();
        } catch (e) {
            console.error(e);
        }
    },

    formatSize(bytes) {
        return bytes < 1024 ? `${bytes} B` :
               bytes < 1024*1024 ? `${(bytes/1024).toFixed(1)} KB` :
               `${(bytes/1024/1024).toFixed(1)} MB`;
    }
}).mount();
</script>
</body>
</html>
