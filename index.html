<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<title>SimpleShare</title>
<script src="https://unpkg.com/petite-vue@0.4.1/dist/petite-vue.iife.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;overflow:hidden}
body{font-family:monospace;background:#f5f5f5;padding:10px;font-size:14px;line-height:1.5;max-width:1200px;margin:0 auto;display:flex;flex-direction:column}
[v-cloak]{display:none}
[btn]{cursor:pointer;border:1px solid #999;padding:8px 14px;background:#fff;border-radius:2px;display:inline-block;font-size:14px;transition:background 0.2s,border-color 0.2s;text-decoration:none;color:#333}
[btn]:hover{background:#e0e0e0;border-color:#777}
[btn]:active{background:#d0d0d0}
[flexr]{display:flex;gap:10px;flex-wrap:wrap}
[flexc]{display:flex;flex-direction:column;gap:10px}
.main-content{display:flex;flex-direction:column;flex:1;min-height:0}
.card{border:1px solid #ccc;padding:15px;background:#fff;border-radius:2px;box-shadow:0 1px 2px rgba(0,0,0,0.05)}
.text-card{display:flex;flex-direction:column;flex:1;overflow:hidden;min-height:0;background:#fff;border:1px solid #ccc;border-top:none;border-radius:0 0 2px 2px;padding:15px}
.tab{border:1px solid #999;padding:8px 16px;background:#fff;cursor:pointer;border-radius:2px 2px 0 0;border-bottom:none;font-size:14px;white-space:nowrap;transition:background 0.2s,border-color 0.2s}
.tab:hover{background:#e0e0e0;border-color:#777}
.tab.actv{background:#e0e0e0;font-weight:bold}
.tab.saved{background:#c8e6c9;border-color:#4caf50}
.tabs-container{border-bottom:1px solid #999;margin-bottom:0;display:flex;gap:2px;flex-wrap:wrap}
.main-tabs{margin-bottom:15px}
.progress-bar{height:3px;background:#e0e0e0;position:relative;border-radius:2px;overflow:hidden}
.progress-fill{height:100%;background:#4caf50;width:0%;transition:none}
.textarea-wrapper{display:flex;flex-direction:column;flex:1;min-height:0}
textarea{width:100%;flex:1;font-family:monospace;border:1px solid #999;padding:10px;resize:none;border-radius:2px;font-size:14px;min-height:200px}
input[type="text"]{border:1px solid #999;padding:8px;font-family:monospace;border-radius:2px;font-size:14px;flex:1}
input[type="file"]{border:1px solid #999;padding:6px;border-radius:2px;font-size:14px}
input[type="checkbox"]{cursor:pointer;margin-right:6px}
label{cursor:pointer;font-size:14px;display:flex;align-items:center}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
.upload-section{margin-bottom:15px}
.text-controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
.texts-wrapper{display:flex;flex-direction:column;flex:1;overflow:hidden;min-height:0}
.footer{text-align:center;padding:10px;font-size:12px;color:#666;border-top:1px solid #ddd;margin-top:10px}
</style>
</head>
<body v-scope @vue:mounted="authLoop" v-cloak>

<div v-if="authed" class="main-content">
    <div class="tabs-container main-tabs">
        <div class="tab" :class="{actv: mainTab==='texts'}" @click="mainTab='texts'; savedTab=null; if (texts.length && !currentText) openText(texts[0].name)">üìù Txts</div>
        <div class="tab" :class="{actv: mainTab==='uploads'}" @click="mainTab='uploads'; savedTab=null">üìÅ Uploads</div>
    </div>

    <div v-if="mainTab==='uploads'" flexc>
        <div class="card upload-section">
            <label btn style="display:inline-block">
                üì§ Choose File
                <input type="file" @change="uploadFile" style="display:none">
            </label>
        </div>
        <div class="grid">
            <div v-for="f in files" class="card" flexc>
                <strong>{{f.name}}</strong>
                <span>{{formatSize(f.size)}}</span>
                <div flexr>
                    <a :href="'/files/'+f.name" download btn>‚¨áÔ∏è Download</a>
                    <span btn @click="deleteFile(f.name)">üóëÔ∏è Delete</span>
                </div>
            </div>
        </div>
    </div>

    <div v-if="mainTab==='texts'" class="texts-wrapper">
        <div class="tabs-container">
            <div v-for="t in texts" class="tab" :class="{actv: currentText?.name===t.name, saved: savedTab===t.name}" @click="openText(t.name)">
                {{t.name}}
            </div>
            <div class="tab" @click="newText">+</div>
        </div>

        <div v-if="currentText" class="text-card">
            <div class="text-controls">
                <input type="text" :value="currentText?.name||''" @input="currentText && (currentText.name=$event.target.value,onTextChange())" placeholder="Text name">
                <label btn>
                    <input type="checkbox" :checked="currentText?.open" @change="currentText && (currentText.open=$event.target.checked,onTextChange())">
                    <span>üåê Public</span>
                </label>
                <span btn @click="currentText && deleteText(currentText.name)">üóëÔ∏è Delete</span>
            </div>
            <div class="textarea-wrapper">
                <textarea :value="currentText?.content||''" @input="currentText && (currentText.content=$event.target.value,onTextChange())"></textarea>
                <div class="progress-bar">
                    <div class="progress-fill" :style="{width: progressWidth + '%'}"></div>
                </div>
            </div>
        </div>
        <div v-else-if="texts.length === 0" class="card">
            <p>No texts yet. Click + to create one.</p>
        </div>
    </div>
</div>

<div class="footer">ITLatam renatop</div>

<script>
PetiteVue.createApp({
    authed: false, mainTab: 'texts', files: [], texts: [], currentText: null,
    debounceTimer: null, progressInterval: null, progressWidth: 0, savedTab: null,
    async authLoop() {
        try {
            const res = await fetch('/auth');
            if (res.ok) { this.authed = true; this.init(); return; }
        } catch (e) { console.error(e); }
        while (!this.authed) {
            const pass = prompt('Password:');
            if (!pass) continue;
            try {
                const res = await fetch('/login', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({password: pass})});
                if (res.ok) { this.authed = true; this.init(); break; }
            } catch (e) { console.error(e); }
        }
    },
    async init() { await this.loadFiles(); await this.loadTexts(); },
    async loadFiles() {
        try { const res = await fetch('/files'); this.files = res.ok ? await res.json() : []; }
        catch (e) { console.error(e); }
    },
    async loadTexts() {
        try {
            const res = await fetch('/txts');
            this.texts = res.ok ? await res.json() : [];
            if (this.texts.length > 0 && !this.currentText) await this.openText(this.texts[0].name);
        } catch (e) { console.error(e); }
    },
    async uploadFile(e) {
        const file = e.target.files[0];
        if (!file) return;
        const formData = new FormData();
        formData.append('file', file);
        try { await fetch('/upload', {method: 'POST', body: formData}); await this.loadFiles(); e.target.value = ''; }
        catch (e) { console.error(e); }
    },
    async deleteFile(name) {
        if (!confirm(`Delete ${name}?`)) return;
        try { await fetch(`/files/${name}`, {method: 'DELETE'}); await this.loadFiles(); }
        catch (e) { console.error(e); }
    },
    async openText(name) {
        this.savedTab = null;
        try {
            const res = await fetch(`/txt/${name}`, {headers: {'Accept': 'application/json'}});
            if (res.ok) { const data = await res.json(); this.currentText = {...data, name, originalName: name}; }
        } catch (e) { console.error(e); }
    },
    onTextChange() {
        if (!this.currentText) return;
        clearTimeout(this.debounceTimer); clearInterval(this.progressInterval); this.progressWidth = 0;
        const startTime = Date.now(), duration = 1500;
        this.progressInterval = setInterval(() => {
            const elapsed = Date.now() - startTime;
            this.progressWidth = Math.min((elapsed / duration) * 100, 100);
        }, 50);
        this.debounceTimer = setTimeout(() => { clearInterval(this.progressInterval); this.progressWidth = 100; this.saveText(); }, duration);
    },
    async saveText() {
        if (!this.currentText?.name) return;
        const oldName = this.currentText.originalName || this.currentText.name;
        const newName = this.currentText.name;
        try {
            if (oldName !== newName) await fetch(`/txt/${oldName}`, {method: 'DELETE'});
            await fetch(`/txt/${newName}`, {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({content: this.currentText.content, open: this.currentText.open})});
            this.currentText.originalName = newName;
            await this.loadTexts();
            this.savedTab = newName;
            setTimeout(() => { this.progressWidth = 0; }, 500);
        } catch (e) { console.error(e); this.progressWidth = 0; }
    },
    async newText() {
        this.savedTab = null;
        let name = 'new', counter = 1;
        const existingNames = this.texts.map(t => t.name);
        while (existingNames.includes(name)) { counter++; name = `new${counter}`; }
        this.currentText = {name, content: '', open: false, originalName: name};
        await this.saveText();
    },
    async deleteText(name) {
        if (!confirm(`Delete ${name}?`)) return;
        clearTimeout(this.debounceTimer); clearInterval(this.progressInterval); this.progressWidth = 0;
        try {
            await fetch(`/txt/${name}`, {method: 'DELETE'});
            if (this.currentText?.name === name) this.currentText = null;
            await this.loadTexts();
            if (this.texts.length > 0 && !this.currentText) await this.openText(this.texts[0].name);
        } catch (e) { console.error(e); }
    },
    formatSize(bytes) {
        return bytes < 1024 ? `${bytes} B` : bytes < 1024*1024 ? `${(bytes/1024).toFixed(1)} KB` : `${(bytes/1024/1024).toFixed(1)} MB`;
    }
}).mount();
</script>
</body>
</html>
